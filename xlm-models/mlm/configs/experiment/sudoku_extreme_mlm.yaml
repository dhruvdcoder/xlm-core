# @package _global_
defaults:
  - /metrics@reported_metrics.val.infill_prediction.exact_match: exact_match
  - /metrics@reported_metrics.val.infill_prediction.token_accuracy: token_accuracy
  - /metrics@reported_metrics.val.infill_prediction.steps_taken: steps_taken
  - /metrics@reported_metrics.test.infill_prediction.exact_match: exact_match
  - /metrics@reported_metrics.test.infill_prediction.token_accuracy: token_accuracy
  - /metrics@reported_metrics.test.infill_prediction.steps_taken: steps_taken
  - override /loggers: wandb
  - override /datamodule: sudoku_extreme_mlm
  - override /model_type: mlm
  - override /model: rotary_transformer_mlm
  - override /loggers: wandb

per_device_batch_size: 512
global_batch_size: 512
block_size: 81
monitored_metric: val/lm/accumulated_loss
add_bos: false
add_eos: false
loss_on_padding: false

datamodule:
  print_batch_fn: mlm.datamodule_mlm.print_batch_mlm

global_components:
  tokenizer:
    _target_: xlm.datamodule.SimpleSpaceTokenizer.for_numbers
    vocab_size: 10

log_predictions:
  _target_: xlm.log_predictions.LogPredictions
  fields_to_keep_in_output:
    - text
    - truth
    - steps_taken
    - exact_match
  inject_target: target_ids
  writers:
    - file
    - logger


trainer:
  max_steps: 80000
  val_check_interval: 10000
  check_val_every_n_epoch: null
  num_sanity_val_steps: 1
  limit_val_batches: 100

predictor:
  max_steps: 81
  top_k: 1
  confidence: top_prob
  threshold: 0.5

optimizer:
  lr: 0.0005

lr_scheduler:
  name: "constant_with_warmup"
  num_warmup_steps: 1000
  num_training_steps: ${trainer.max_steps}
  monitor: "train/loss"

reported_metrics:
  val:
    infill_prediction:
      exact_match:
        prefix: val/prediction
        update_fn: mlm.metrics_mlm.exact_match_update_fn
      token_accuracy:
        prefix: val/prediction
        update_fn: mlm.metrics_mlm.infill_token_accuracy_update_fn
      steps_taken:
        prefix: val/prediction
        update_fn: xlm.metrics.steps_taken_update_fn
  test:
    infill_prediction:
      exact_match:
        prefix: test/prediction
        update_fn: mlm.metrics_mlm.exact_match_update_fn
      token_accuracy:
        prefix: test/prediction
        update_fn: mlm.metrics_mlm.infill_token_accuracy_update_fn
      steps_taken:
        prefix: test/prediction
        update_fn: xlm.metrics.steps_taken_update_fn

callbacks:
  checkpoint_every_n_steps:
    every_n_train_steps: 10000 # save temp checkpoint every 10k steps incase of failure
    keep_multiple: 40 # (40 * 10000 = 400000: permanently saved checkpoints at every 400k steps)
